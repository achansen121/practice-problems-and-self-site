var fs=require('fs');
var promise=require("promise.js");



var stat_promises={};

var sfl_unused={"f.js":true,"simple.js":true,"lib/fix_object_keys.js":true,"lib/sha1.js":true,
  "data_structures.js":true,"algo.js":true,"practice_problems.js":true,"lib/core.js":true,
  "data/words-en.txt":true,"actual_1.js":true,"f.css":true,"canvastry.js":true};
sfl_unused={};
var sc=function(req,res){
  sc.find_all("static/")
  .subscribe(function(err,sfl){

  var sp=sc.stat_files("",Object.keys(sfl));
  sp.subscribe(function(err,fmap){
    if(err)
      return res.backup();
    res.writeHead(200,{"Content-Type":"application/javascript","Cache-Control":"public,max-age="+(60*60*24*7)});
    res.write("window.jsfilemtime="+JSON.stringify(fmap.times)+";");
    res.end();
                                                                    });
                                                                    });
};
var ptime=60*1000;
var plongtime=ptime*60;

sc.find_all=function(folder){
  return promise(stat_promises,"readall]"+folder.length+"]"+folder)
  .ensure_terminate(function(p){
    console.log("recursive stating "+folder);
    var fsub={};
    fs.readdir(folder,function(err,files){
      var fcount=0;
      for (var i = 0; i < files.length; i++) {
        var pf=promise(stat_promises,"stat_dirall]"+folder.length+folder+"]"+files[i]);
        pf.ensure_terminate(function(pinner){
          fs.stat(folder+files[i],function(err,data){
            pinner.finish(err,data);
          });
        });
        pf.subscribe((function(fname){
          return function(err,data){
          if(data.isDirectory()){
            var rec=sc.find_all(folder+fname+"/");
            rec.subscribe(function(err,allfin){
              if(allfin&&typeof allfin=="object"){
                var allfinkeys=Object.keys(allfin);
                for (var i = 0; i < allfinkeys.length; i++) {
                  fsub[allfinkeys[i]]=true;
                };
              }
              fcount+=1;
              if(fcount==files.length)
                p.finish(false,fsub,{dt:plongtime});
            });
          }
          else{
            fsub[folder+fname]=true;
            fcount+=1;
            if(fcount==files.length)
              p.finish(false,fsub,{dt:plongtime});
          }
        }})(files[i]));
      };
    });
  });
}

sc.stat_files=function(root,file_list){

  var fstr=JSON.stringify(file_list);

  var stat_all=promise(stat_promises,"stat_fl]"+root.length+"]"+root+fstr.length+"]"+fstr);
  var gathered={times:{},num:0,max:file_list.length};
  gathered.newest=0;
  stat_all.ensure_terminate(function(){

    for (var i = 0; i < file_list.length; i++) {
      var full_name=root+file_list[i];
      var stat_indiv=promise(stat_promises,"stat_single "+full_name);
      stat_indiv.ensure_terminate(function(){
        var associate_name=(function(p,nm){return function(err,stats){
          console.log("stat "+nm);
          stats.fname=nm;
          p.finish(err,stats,{dt:ptime});
        };})(stat_indiv,full_name);
        fs.stat(full_name,associate_name);
      });
      stat_indiv.subscribe(function(err,data){
        if(err)
          return stat_all.finish(new Error("file read err"),{});
        var ct=data.mtime.getTime();
        if("newest" in gathered && ct>gathered.newest)
          gathered.newest=ct;
        gathered.times["/"+data.fname]=ct;
        gathered.num++;
        if(gathered.num>=gathered.max)
          stat_all.finish(false,gathered,{dt:ptime});
      });
    };
  });
  return stat_all;
};

sc.get_version=function(){

  return promise(stat_promises,"stat_version")
  .ensure_terminate(function(p){

  sc.find_all("static/")
  .subscribe(function(err,sfl){
    sc.stat_files("",Object.keys(sfl))
    .subscribe(function(err,data){
      p.finish(err,data.newest,{dt:60*1000});
    });
  });
  });
};

module.exports=sc;